<div class="container mx-auto px-4 py-8">
  <!-- Header -->
  <div class="flex justify-between items-center mb-8">
    <div>
      <h1 class="text-3xl font-bold text-gray-800">Exam Management</h1>
      <p class="text-gray-600 mt-2">Gérer les examens des cours</p>
    </div>
    <button 
      (click)="openCreateModal()"
      class="bg-gradient-to-r from-primary to-accent text-white px-6 py-3 rounded-lg hover:shadow-lg transition-all flex items-center gap-2">
      <span class="material-icons">add</span>
      Créer un Examen
    </button>
  </div>

  <!-- Loading -->
  <div *ngIf="loading && exams.length === 0" class="text-center py-12">
    <div class="inline-block animate-spin rounded-full h-12 w-12 border-b-2 border-primary"></div>
    <p class="mt-4 text-gray-600">Chargement des examens...</p>
  </div>

  <!-- Empty State -->
  <div *ngIf="!loading && exams.length === 0" class="text-center py-12 bg-white rounded-xl shadow-sm">
    <span class="material-icons text-6xl text-gray-300">assignment</span>
    <h3 class="text-xl font-semibold text-gray-700 mt-4">Aucun examen</h3>
    <p class="text-gray-500 mt-2">Créez votre premier examen pour commencer</p>
  </div>

  <!-- Exams Grid -->
  <div *ngIf="exams.length > 0" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
    <div *ngFor="let exam of exams" class="bg-white rounded-xl shadow-sm hover:shadow-lg transition-all overflow-hidden">
      <div class="p-6">
        <div class="flex items-start justify-between mb-4">
          <div class="flex-1">
            <div class="flex items-center gap-2 mb-2">
              <span [class]="'px-2 py-1 rounded text-xs font-semibold ' + (exam.isActive ? 'bg-green-100 text-green-800' : 'bg-gray-100 text-gray-800')">
                {{ exam.isActive ? 'Actif' : 'Inactif' }}
              </span>
            </div>
            <h3 class="text-xl font-semibold text-gray-800 mb-2">{{ exam.title }}</h3>
            <p class="text-gray-600 text-sm line-clamp-3">{{ exam.description }}</p>
          </div>
        </div>
        
        <div class="space-y-2 mb-4 text-sm text-gray-600">
          <div class="flex items-center gap-2">
            <span class="material-icons text-sm">{{ exam.examType === 'QUIZ' ? 'quiz' : 'assignment' }}</span>
            <span class="font-semibold" [class.text-blue-600]="exam.examType === 'QUIZ'" [class.text-purple-600]="exam.examType === 'EXAM'">
              {{ getExamTypeLabel(exam.examType) }}
            </span>
          </div>
          <div class="flex items-center gap-2">
            <span class="material-icons text-sm">{{ exam.examType === 'QUIZ' ? 'school' : 'workspace_premium' }}</span>
            <span>{{ getExamAssociation(exam) }}</span>
          </div>
          <div class="flex items-center gap-2">
            <span class="material-icons text-sm">schedule</span>
            <span>{{ exam.duration }} minutes</span>
          </div>
          <div class="flex items-center gap-2">
            <span class="material-icons text-sm">grade</span>
            <span>{{ exam.passingScore }}% pour réussir</span>
          </div>
          <div class="flex items-center gap-2">
            <span class="material-icons text-sm">stars</span>
            <span>{{ exam.totalMarks }} points</span>
          </div>
        </div>

        <div class="flex gap-2">
          <button 
            (click)="openEditModal(exam)"
            class="flex-1 bg-blue-50 text-blue-600 px-4 py-2 rounded-lg hover:bg-blue-100 transition-all flex items-center justify-center gap-2">
            <span class="material-icons text-sm">edit</span>
            Modifier
          </button>
          <button 
            (click)="deleteExam(exam.id!)"
            class="flex-1 bg-red-50 text-red-600 px-4 py-2 rounded-lg hover:bg-red-100 transition-all flex items-center justify-center gap-2">
            <span class="material-icons text-sm">delete</span>
            Supprimer
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Exam Modal -->
<div *ngIf="showModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
  <div class="bg-white rounded-xl shadow-2xl max-w-4xl w-full max-h-[90vh] overflow-y-auto">
    <div class="p-6 border-b border-gray-200">
      <div class="flex justify-between items-center">
        <div>
          <h2 class="text-2xl font-bold text-gray-800">
            {{ isEditMode ? 'Modifier l\'Examen' : 'Nouvel Examen' }}
          </h2>
          <div class="flex items-center gap-4 mt-2">
            <div class="flex items-center gap-2">
              <div [class]="'w-8 h-8 rounded-full flex items-center justify-center ' + (currentStep === 'info' ? 'bg-primary text-white' : 'bg-gray-200 text-gray-600')">1</div>
              <span class="text-sm font-medium">Informations</span>
            </div>
            <div class="w-12 h-0.5 bg-gray-300"></div>
            <div class="flex items-center gap-2">
              <div [class]="'w-8 h-8 rounded-full flex items-center justify-center ' + (currentStep === 'questions' ? 'bg-primary text-white' : 'bg-gray-200 text-gray-600')">2</div>
              <span class="text-sm font-medium">Questions</span>
            </div>
          </div>
        </div>
        <button (click)="closeModal()" class="text-gray-400 hover:text-gray-600">
          <span class="material-icons">close</span>
        </button>
      </div>
    </div>

    <form [formGroup]="examForm" (ngSubmit)="onSubmit()" class="p-6">
      <!-- Étape 1: Informations de base -->
      <div *ngIf="currentStep === 'info'">
        <!-- Exam Type -->
        <div class="mb-6">
          <label class="block text-sm font-semibold text-gray-700 mb-2">
            Type d'examen <span class="text-red-500">*</span>
          </label>
          <div class="grid grid-cols-2 gap-4">
            <label class="flex items-center p-4 border-2 rounded-lg cursor-pointer transition-all"
                   [class.border-blue-500]="examForm.get('examType')?.value === 'QUIZ'"
                   [class.bg-blue-50]="examForm.get('examType')?.value === 'QUIZ'">
              <input type="radio" formControlName="examType" value="QUIZ" class="mr-3">
              <div>
                <div class="font-semibold text-blue-600">QUIZ</div>
                <div class="text-xs text-gray-600">Associé à un cours</div>
              </div>
            </label>
            <label class="flex items-center p-4 border-2 rounded-lg cursor-pointer transition-all"
                   [class.border-purple-500]="examForm.get('examType')?.value === 'EXAM'"
                   [class.bg-purple-50]="examForm.get('examType')?.value === 'EXAM'">
              <input type="radio" formControlName="examType" value="EXAM" class="mr-3">
              <div>
                <div class="font-semibold text-purple-600">EXAMEN</div>
                <div class="text-xs text-gray-600">Associé à une formation</div>
                <div class="text-xs text-purple-600 mt-1">Questions à réponse courte uniquement</div>
              </div>
            </label>
          </div>
        </div>

        <!-- Course/Training Selection -->
        <div *ngIf="examForm.get('examType')?.value === 'QUIZ'" class="mb-6">
          <label class="block text-sm font-semibold text-gray-700 mb-2">
            Cours <span class="text-red-500">*</span>
          </label>
          <select formControlName="courseId" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
            <option [value]="null">Sélectionner un cours...</option>
            <option *ngFor="let course of courses" [value]="course.courseId">{{ course.title }}</option>
          </select>
        </div>

        <div *ngIf="examForm.get('examType')?.value === 'EXAM'" class="mb-6">
          <label class="block text-sm font-semibold text-gray-700 mb-2">
            Formation <span class="text-red-500">*</span>
          </label>
          <select formControlName="trainingId" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500">
            <option [value]="null">Sélectionner une formation...</option>
            <option *ngFor="let training of trainings" [value]="training.trainingId">{{ training.title }}</option>
          </select>
        </div>

        <!-- Title -->
        <div class="mb-6">
          <label class="block text-sm font-semibold text-gray-700 mb-2">
            Titre <span class="text-red-500">*</span>
          </label>
          <input type="text" formControlName="title" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary" placeholder="Ex: Quiz Angular Basics">
        </div>

        <!-- Description -->
        <div class="mb-6">
          <label class="block text-sm font-semibold text-gray-700 mb-2">Description</label>
          <textarea formControlName="description" rows="3" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary"></textarea>
        </div>

        <!-- Duration & Passing Score -->
        <div class="grid grid-cols-2 gap-4 mb-6">
          <div>
            <label class="block text-sm font-semibold text-gray-700 mb-2">
              Durée (minutes) <span class="text-red-500">*</span>
            </label>
            <input type="number" formControlName="duration" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary" placeholder="60">
          </div>
          <div>
            <label class="block text-sm font-semibold text-gray-700 mb-2">
              Score de passage (%) <span class="text-red-500">*</span>
            </label>
            <input type="number" formControlName="passingScore" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary" placeholder="70">
          </div>
        </div>

        <!-- Start & End Date -->
        <div class="grid grid-cols-2 gap-4 mb-6">
          <div>
            <label class="block text-sm font-semibold text-gray-700 mb-2">Date de début</label>
            <input type="datetime-local" formControlName="startDate" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary">
          </div>
          <div>
            <label class="block text-sm font-semibold text-gray-700 mb-2">Date de fin</label>
            <input type="datetime-local" formControlName="endDate" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary">
          </div>
        </div>

        <!-- Is Active -->
        <div class="mb-6">
          <label class="flex items-center gap-2 cursor-pointer">
            <input type="checkbox" formControlName="isActive" class="w-5 h-5 text-primary border-gray-300 rounded focus:ring-primary">
            <span class="text-sm font-semibold text-gray-700">Examen actif</span>
          </label>
        </div>

        <!-- Navigation -->
        <div class="flex gap-4">
          <button type="button" (click)="closeModal()" class="flex-1 px-6 py-3 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50">
            Annuler
          </button>
          <button type="button" (click)="nextStep()" class="flex-1 bg-gradient-to-r from-primary to-accent text-white px-6 py-3 rounded-lg hover:shadow-lg">
            Suivant: Questions
          </button>
        </div>
      </div>

      <!-- Étape 2: Questions -->
      <div *ngIf="currentStep === 'questions'">
        <div class="mb-6">
          <div class="flex justify-between items-center mb-4">
            <div>
              <h3 class="text-lg font-semibold text-gray-800">Questions</h3>
              <p class="text-sm text-gray-600">Total des points: <span class="font-bold text-primary">{{ getTotalMarks() }}</span></p>
            </div>
            <button type="button" (click)="addQuestion()" class="bg-green-500 text-white px-4 py-2 rounded-lg hover:bg-green-600 flex items-center gap-2">
              <span class="material-icons text-sm">add</span>
              Ajouter une question
            </button>
          </div>

          <!-- Liste des questions -->
          <div formArrayName="questions" class="space-y-6">
            <div *ngFor="let question of questions.controls; let i = index" [formGroupName]="i" class="border border-gray-200 rounded-lg p-4 bg-gray-50">
              <div class="flex justify-between items-start mb-4">
                <h4 class="font-semibold text-gray-700">Question {{ i + 1 }}</h4>
                <button type="button" (click)="removeQuestion(i)" class="text-red-500 hover:text-red-700">
                  <span class="material-icons text-sm">delete</span>
                </button>
              </div>

              <!-- Question Text -->
              <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-2">Texte de la question <span class="text-red-500">*</span></label>
                <textarea formControlName="questionText" rows="2" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary" placeholder="Entrez votre question..."></textarea>
              </div>

              <!-- Question Type & Marks -->
              <div class="grid grid-cols-2 gap-4 mb-4">
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-2">Type <span class="text-red-500">*</span></label>
                  <select formControlName="questionType" (change)="onQuestionTypeChange(i, question.get('questionType')?.value)" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary">
                    <!-- Pour les QUIZ: tous les types -->
                    <ng-container *ngIf="examForm.get('examType')?.value === 'QUIZ'">
                      <option value="MULTIPLE_CHOICE">Choix multiples</option>
                      <option value="TRUE_FALSE">Vrai/Faux</option>
                      <option value="SHORT_ANSWER">Réponse courte</option>
                    </ng-container>
                    <!-- Pour les EXAM: uniquement réponse courte -->
                    <ng-container *ngIf="examForm.get('examType')?.value === 'EXAM'">
                      <option value="SHORT_ANSWER">Réponse courte</option>
                    </ng-container>
                  </select>
                  <p *ngIf="examForm.get('examType')?.value === 'EXAM'" class="text-xs text-purple-600 mt-1">
                    <span class="material-icons text-xs align-middle">info</span>
                    Les examens utilisent uniquement des réponses courtes
                  </p>
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-2">Points <span class="text-red-500">*</span></label>
                  <input type="number" formControlName="marks" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary" min="1">
                </div>
              </div>

              <!-- Options (pour MULTIPLE_CHOICE et TRUE_FALSE) -->
              <div *ngIf="question.get('questionType')?.value === 'MULTIPLE_CHOICE' || question.get('questionType')?.value === 'TRUE_FALSE'" class="mb-4">
                <div class="flex justify-between items-center mb-2">
                  <label class="block text-sm font-medium text-gray-700">Options de réponse</label>
                  <button *ngIf="question.get('questionType')?.value === 'MULTIPLE_CHOICE'" type="button" (click)="addOption(i)" class="text-blue-500 hover:text-blue-700 text-sm flex items-center gap-1">
                    <span class="material-icons text-sm">add</span>
                    Ajouter option
                  </button>
                </div>
                <div formArrayName="options" class="space-y-2">
                  <div *ngFor="let option of getQuestionOptions(i).controls; let j = index" [formGroupName]="j" class="flex items-center gap-2">
                    <input type="text" formControlName="optionText" class="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary" placeholder="Texte de l'option">
                    <label class="flex items-center gap-1 px-3 py-2 bg-white border border-gray-300 rounded-lg cursor-pointer hover:bg-gray-50">
                      <input type="checkbox" formControlName="isCorrect" class="w-4 h-4 text-green-500">
                      <span class="text-xs text-gray-600">Correcte</span>
                    </label>
                    <button *ngIf="question.get('questionType')?.value === 'MULTIPLE_CHOICE' && getQuestionOptions(i).length > 2" type="button" (click)="removeOption(i, j)" class="text-red-500 hover:text-red-700">
                      <span class="material-icons text-sm">close</span>
                    </button>
                  </div>
                </div>
              </div>

              <!-- Correct Answer (pour SHORT_ANSWER) -->
              <div *ngIf="question.get('questionType')?.value === 'SHORT_ANSWER'" class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-2">Réponse correcte</label>
                <input type="text" formControlName="correctAnswer" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary" placeholder="Entrez la réponse attendue">
              </div>
            </div>

            <!-- Empty state -->
            <div *ngIf="questions.length === 0" class="text-center py-12 bg-white rounded-lg border-2 border-dashed border-gray-300">
              <span class="material-icons text-6xl text-gray-300">quiz</span>
              <p class="text-gray-500 mt-2">Aucune question ajoutée</p>
              <p class="text-sm text-gray-400">Cliquez sur "Ajouter une question" pour commencer</p>
            </div>
          </div>
        </div>

        <!-- Navigation -->
        <div class="flex gap-4">
          <button type="button" (click)="previousStep()" class="flex-1 px-6 py-3 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50">
            Précédent
          </button>
          <button type="submit" [disabled]="examForm.invalid || loading" class="flex-1 bg-gradient-to-r from-primary to-accent text-white px-6 py-3 rounded-lg hover:shadow-lg disabled:opacity-50">
            {{ isEditMode ? 'Mettre à jour' : 'Créer l\'examen' }}
          </button>
        </div>
      </div>
    </form>
  </div>
</div>
